<!DOCTYPE html>
<html lang="am">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus – Driver</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
body {
    margin: 0;
    background: #1a1a1a;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    transition: background 0.5s;
}
#status {
    margin-top: 35vh;
    font-size: 2.2rem;
    font-weight: bold;
}
#gps {
    position: absolute;
    bottom: 20px;
    width: 100%;
    font-size: 1rem;
    color: #aaa;
}
</style>
</head>

<body>

<div id="status">
    አሽከርካሪ ንቁ<br>
    <span style="font-size:1.2rem">
        ተሳፋሪዎችን በመጠባበቅ ላይ…
    </span>
</div>

<div id="gps">በመገናኘት ላይ…</div>

<script>
/* ================= CONFIG ================= */
const AUDIO_BASE =
  "https://YOUR_GITHUB_USERNAME.github.io/YOUR_REPO_NAME/";
/* ========================================== */

const statusDiv = document.getElementById("status");
const gpsDiv = document.getElementById("gps");

/* AUDIO */
function playAudio(file) {
    const audio = new Audio(AUDIO_BASE + file);
    audio.play();
}

/* MQTT */
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8884,
    "driver_" + Math.random()
);

client.connect({
    useSSL: true,
    onSuccess: () => {
        gpsDiv.innerText = "ተገናኝቷል | GPS በመላክ ላይ";
        client.subscribe("smart_bus_project/driver_alerts");
        startGPS();
    }
});

/* RECEIVE PASSENGER ALERT */
client.onMessageArrived = message => {
    const data = JSON.parse(message.payloadString);

    document.body.style.background = "red";

    statusDiv.innerHTML =
        "አካል ጉዳተኛ ተሳፋሪ በመጠባበቅ ላይ<br>" +
        "ጣቢያ: " + data.station + "<br>" +
        "አውቶቡስ: " + data.bus;

    playAudio("alert.wav");
    navigator.vibrate?.([600, 300, 600]);

    setTimeout(() => {
        document.body.style.background = "#1a1a1a";
        statusDiv.innerHTML =
            "አሽከርካሪ ንቁ<br>" +
            "<span style='font-size:1.2rem'>ተሳፋሪዎችን በመጠባበቅ ላይ…</span>";
    }, 15000);
};

/* GPS */
function startGPS() {
    navigator.geolocation.watchPosition(
        pos => {
            const coords = {
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
            };

            const msg = new Paho.MQTT.Message(JSON.stringify(coords));
            msg.destinationName = "smart_bus_project/bus_location";
            client.send(msg);

            gpsDiv.innerText =
                "GPS: " +
                coords.lat.toFixed(5) +
                ", " +
                coords.lon.toFixed(5);
        },
        () => {
            gpsDiv.innerText = "GPS ስህተት";
        },
        { enableHighAccuracy: true }
    );
}
</script>

</body>
</html>


