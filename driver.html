<!DOCTYPE html>
<html lang="am">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus ‚Äì Driver</title>

<style>
body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
}
#main {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
#message {
    font-size: 2.2rem;
    margin-bottom: 30px;
}
#debug {
    font-size: 1rem;
    color: #00ff00;
    font-family: monospace;
}
button {
    font-size: 2rem;
    padding: 20px 40px;
    border: none;
    background: yellow;
    color: black;
}
</style>
</head>

<body>
<div id="main">
    <div id="message">·â∞·à≥·çã·à™·ãé·âΩ·äï ·â†·àò·å†·â†·âÖ ·àã·ã≠...</div>
    <button id="startBtn">·åÄ·àù·à≠</button>
    <div id="debug"></div>
</div>

<script>
/* ================= CONFIG ================= */
const AUDIO_BASE = "https://robel494.github.io/bus/";
const NEAR_RSSI = -40;
/* ========================================= */

const message = document.getElementById("message");
const debug = document.getElementById("debug");
const startBtn = document.getElementById("startBtn");

/* --- Audio --- */
const sounds = {
    alert: new Audio(AUDIO_BASE + "Alert.wav"),
    pickup: new Audio(AUDIO_BASE + "Pickup.wav")
};

function play(name) {
    sounds[name].currentTime = 0;
    sounds[name].play().catch(()=>{});
}

/* --- State --- */
let pickupPlayed = false;

/* --- Notification --- */
async function notifyPassenger() {
    if (Notification.permission !== "granted") {
        await Notification.requestPermission();
    }

    if (Notification.permission === "granted") {
        new Notification("Smart Bus", {
            body: "·ä†·äï·ãµ ·ãì·ã≠·äê ·àµ·ãç·à≠ ·â∞·à≥·çã·à™ ·â†·å£·â¢·ã´ 3 ·ä•·ã®·å†·â†·âÄ ·äê·ãç üöè"
        });
    }
}

/* --- Bluetooth --- */
async function startBluetooth() {
    try {
        // üëá THIS IS THE ‚ÄúPAIR‚Äù MOMENT
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true
        });

        /* ‚úÖ PAIR SUCCESS ‚Üí NOTIFICATION + ALERT */
        message.innerText =
          "·ä†·äï·ãµ ·ãì·ã≠·äê ·àµ·ãç·à≠ ·â∞·à≥·çã·à™ ·â†·å£·â¢·ã´ 3 ·ä•·ã®·å†·â†·âÄ ·äê·ãç";
        play("alert");
        notifyPassenger();
        navigator.vibrate?.(500);

        /* Start proximity tracking */
        await device.watchAdvertisements();

        device.addEventListener("advertisementreceived", e => {
            const rssi = e.rssi;
            debug.innerText = `RSSI: ${rssi}`;

            if (rssi >= NEAR_RSSI && !pickupPlayed) {
                pickupPlayed = true;
                message.innerText = "·â∞·à≥·çã·à™·ãç ·â∞·âÄ·â•·àè·àç";
                play("pickup");
                navigator.vibrate?.([300,200,300]);
            }
        });

    } catch (e) {
        message.innerText = "·â•·àâ·â±·ãù ·ä†·àç·â∞·åà·äì·äò·àù";
        console.error(e);
    }
}

startBtn.onclick = () => {
    startBtn.style.display = "none";
    startBluetooth();
};
</script>
</body>
</html>
