<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bus - Driver</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; margin: 0; transition: background 0.5s; }
        #status { margin-top: 40vh; font-size: 2.5rem; font-weight: bold; }
        #gps-info { position: absolute; bottom: 20px; width: 100%; color: #888; }
    </style>
</head>
<body>
    <div id="status">DRIVER ACTIVE<br><span style="font-size: 1.2rem;">Waiting for Passengers...</span></div>
    <div id="gps-info">Initializing GPS...</div>

    <script>
        const statusDiv = document.getElementById('status');
        const gpsDiv = document.getElementById('gps-info');
        
        // Line 24: Cloud Connection (Must match User App settings)
        const client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "driver_" + Math.random());

        client.connect({
            useSSL: true,
            onSuccess: () => {
                gpsDiv.innerText = "Connected | Broadcasting GPS";
                client.subscribe("smart_bus_project/driver_alerts");
                startGpsSharing();
            }
        });

        // Line 35: Listen for Passenger Voice Commands
        client.onMessageArrived = (message) => {
            document.body.style.background = "red";
            statusDiv.innerHTML = "PASSENGER WAITING!<br>BUS: " + message.payloadString;
            
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Passenger waiting for bus " + message.payloadString));

            if (navigator.vibrate) navigator.vibrate(1000);

            // Reset screen after 15 seconds
            setTimeout(() => {
                document.body.style.background = "#1a1a1a";
                statusDiv.innerHTML = "DRIVER ACTIVE<br><span style='font-size: 1.2rem;'>Waiting for Passengers...</span>";
            }, 15000);
        };

        // Line 52: Send GPS to User App
        function startGpsSharing() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    const msg = new Paho.MQTT.Message(JSON.stringify(coords));
                    msg.destinationName = "smart_bus_project/bus_location";
                    client.send(msg);
                    gpsDiv.innerText = "GPS Active: " + coords.lat.toFixed(4) + ", " + coords.lon.toFixed(4);
                }, err => { gpsDiv.innerText = "GPS Error: Please Allow Location"; }, { enableHighAccuracy: true });
            }
        }
    </script>
</body>
</html>
