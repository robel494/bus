<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus – Driver</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
body {
    margin: 0;
    background: #1a1a1a;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    transition: background 0.5s;
}
#status {
    margin-top: 35vh;
    font-size: 2.5rem;
    font-weight: bold;
}
#gps {
    position: absolute;
    bottom: 20px;
    width: 100%;
    font-size: 1rem;
    color: #aaa;
}
</style>
</head>

<body>

<div id="status">
    DRIVER ACTIVE<br>
    <span style="font-size:1.2rem">Waiting for passengers…</span>
</div>

<div id="gps">Connecting…</div>

<script>
const statusDiv = document.getElementById("status");
const gpsDiv = document.getElementById("gps");

/* MQTT CONNECTION (SSL) */
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8884,
    "driver_" + Math.random()
);

client.connect({
    useSSL: true,
    onSuccess: () => {
        gpsDiv.innerText = "Connected | GPS broadcasting";
        client.subscribe("smart_bus_project/driver_alerts");
        startGPS();
    },
    onFailure: e => {
        gpsDiv.innerText = "Connection failed";
    }
});

/* RECEIVE PASSENGER ALERT */
client.onMessageArrived = message => {
    document.body.style.background = "red";
    statusDiv.innerHTML =
        "PASSENGER WAITING<br>BUS: " + message.payloadString;

    speechSynthesis.speak(
        new SpeechSynthesisUtterance(
            "Passenger waiting for bus " + message.payloadString
        )
    );

    navigator.vibrate?.([500, 300, 500]);

    setTimeout(() => {
        document.body.style.background = "#1a1a1a";
        statusDiv.innerHTML =
            "DRIVER ACTIVE<br><span style='font-size:1.2rem'>Waiting for passengers…</span>";
    }, 15000);
};

/* GPS SHARING */
function startGPS() {
    if (!navigator.geolocation) {
        gpsDiv.innerText = "GPS not supported";
        return;
    }

    // Android WebView will trigger permission prompt automatically
    navigator.geolocation.watchPosition(
        pos => {
            const coords = {
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
            };

            const msg = new Paho.MQTT.Message(JSON.stringify(coords));
            msg.destinationName = "smart_bus_project/bus_location";
            client.send(msg);

            gpsDiv.innerText =
                "GPS: " +
                coords.lat.toFixed(4) +
                ", " +
                coords.lon.toFixed(4);
        },
        err => {
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    gpsDiv.innerText = "GPS permission denied";
                    break;
                case err.POSITION_UNAVAILABLE:
                    gpsDiv.innerText = "GPS position unavailable";
                    break;
                case err.TIMEOUT:
                    gpsDiv.innerText = "GPS timeout";
                    break;
                default:
                    gpsDiv.innerText = "GPS error";
            }
        },
        { enableHighAccuracy: true }
    );
}
</script>

</body>
</html>
