<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bus – Proximity</title>
    <style>
        body { margin: 0; background: black; font-family: Arial, sans-serif; overflow: hidden; color: white; }
        #btn { width: 100vw; height: 100vh; font-size: 2.5rem; font-weight: bold; background: yellow; color: black; border: none; }
        #status { position: absolute; bottom: 80px; width: 100%; text-align: center; color: #aaa; font-size: 1.1rem; }
        #debug { position: absolute; top: 20px; width: 100%; text-align: center; font-family: monospace; color: #00ff00; }
    </style>
</head>
<body>

<div id="debug">GPS: በመፈለግ ላይ... | Bluetooth: --</div>
<button id="btn">ጀምር</button>
<div id="status">ለመጀመር ቢጫውን ይጫኑ</div>

<script>
/* ================= CONFIG ================= */
const AUDIO_BASE = "https://robel494.github.io/bus/";
const ARRIVAL_THRESHOLD_CM = 5; // Trigger "Arrived" only at 5cm
/* ========================================== */

const btn = document.getElementById("btn");
const status = document.getElementById("status");
const debug = document.getElementById("debug");

// Audio setup
const sounds = {
    destination: new Audio(AUDIO_BASE + "Destination.wav"),
    alert: new Audio(AUDIO_BASE + "Alert.wav"),
    arrived: new Audio(AUDIO_BASE + "Arrived.wav"),
    sent: new Audio(AUDIO_BASE + "sent.wav"),
    listen: new Audio(AUDIO_BASE + "Listen.wav"),
    pickup: new Audio(AUDIO_BASE + "Pickup.wav"),
    unboard: new Audio(AUDIO_BASE + "Unboard.wav")
};

function play(key) {
    if(sounds[key]) {
        sounds[key].currentTime = 0;
        sounds[key].play().catch(e => console.log("Audio play blocked"));
    }
}

/* --- Bluetooth RSSI Logic --- */
function rssiToCm(rssi) {
    const txPower = -59; // Reference RSSI at 1 meter
    if (rssi == 0) return 999;
    const ratio = (txPower - rssi) / (10 * 2);
    return Math.round(Math.pow(10, ratio) * 100); 
}

async function initBluetooth() {
    try {
        const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
        const abortController = new AbortController();
        await device.watchAdvertisements({ signal: abortController.signal });

        device.addEventListener('advertisementreceived', (event) => {
            const rssi = event.rssi;
            const distCm = rssiToCm(rssi);
            const time = new Date().getSeconds();

            debug.innerText = `ጊዜ: ${time}ሰ | RSSI: ${rssi} | ርቀት: ${distCm}cm`;

            if (distCm <= ARRIVAL_THRESHOLD_CM) {
                btn.innerText = "አውቶቡስ ደርሷል";
                btn.style.background = "#00ff00";
                play('arrived');
                navigator.vibrate?.([500, 200, 500]);
            }
        });
    } catch (e) {
        status.innerText = "ብሉቱዝ አልተገናኘም";
    }
}

/* --- GPS Logic --- */
navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude.toFixed(5);
    const lon = pos.coords.longitude.toFixed(5);
    // Note: We display GPS here, but Arrived is handled by Bluetooth
    if (btn.innerText !== "አውቶቡስ ደርሷል") {
        status.innerText = `GPS: ${lat}, ${lon}`;
    }
}, null, { enableHighAccuracy: true });

/* --- Speech Recognition --- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = "en-US";

recognition.onresult = e => {
    const transcript = e.results[0][0].transcript.toLowerCase();
    
    // Command Logic
    if (transcript.includes("pickup")) play('pickup');
    if (transcript.includes("destination")) play('destination');
    if (transcript.includes("stop")) play('unboard');
    
    play('sent');
    btn.innerText = "ትእዛዝ ተልኳል";
    btn.style.background = "black";
    btn.style.color = "yellow";
};

btn.onclick = () => {
    play('listen');
    btn.innerText = "በመስማት ላይ...";
    btn.style.background = "red";
    
    // Initialize Bluetooth on first click
    initBluetooth();
    
    setTimeout(() => recognition.start(), 1000);
};

</script>
</body>
</html>
