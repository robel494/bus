<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart Bus â€“ Voice Passenger</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
body {
    margin: 0;
    height: 100vh;
    background: #020617;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

h1 {
    font-size: 2rem;
}

button {
    margin-top: 25px;
    padding: 18px 28px;
    font-size: 1.2rem;
    border: none;
    border-radius: 12px;
    background: #22c55e;
    color: black;
}

#status {
    margin-top: 25px;
    font-size: 1.1rem;
    color: #ccc;
    text-align: center;
}
</style>
</head>

<body>

<h1>Smart Bus</h1>

<button onclick="startVoice()">ðŸŽ¤ Speak Bus Number</button>

<div id="status">Tap the button and speak</div>

<script>
const statusEl = document.getElementById("status");

/* ==============================
   SPEECH SETUP
================================ */
const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.lang = "en-US";
recognition.continuous = false;
recognition.interimResults = false;

/* ==============================
   MQTT
================================ */
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8884,
    "blind_user_" + Math.random().toString(16).substr(2, 8)
);

client.connect({
    useSSL: true,
    onSuccess: () => {
        speak("Connected. Please say your bus number.");
        statusEl.innerText = "Connected";
        getUserLocation();
        client.subscribe("smart_bus_project/bus_location");
    }
});

/* ==============================
   START VOICE
================================ */
function startVoice() {
    speak("Listening. Please say your bus number.");
    recognition.start();
}

/* ==============================
   SPEECH â†’ TEXT
================================ */
recognition.onresult = event => {
    const text = event.results[0][0].transcript;
    statusEl.innerText = "Heard: " + text;

    speak("Bus " + text + ". Alerting the driver.");
    sendAlert(text);
};

recognition.onerror = () => {
    speak("Sorry. I did not understand. Please try again.");
};

/* ==============================
   SEND ALERT
================================ */
function sendAlert(bus) {
    const msg = new Paho.MQTT.Message(bus);
    msg.destinationName = "smart_bus_project/driver_alerts";
    client.send(msg);
}

/* ==============================
   TEXT â†’ SPEECH
================================ */
function speak(text) {
    speechSynthesis.cancel();
    speechSynthesis.speak(
        new SpeechSynthesisUtterance(text)
    );
}

/* ==============================
   USER GPS
================================ */
let userLoc = null;
let busLoc = null;

function getUserLocation() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(pos => {
        userLoc = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
        };
    });
}

/* ==============================
   BUS GPS & PROXIMITY
================================ */
client.onMessageArrived = msg => {
    try {
        busLoc = JSON.parse(msg.payloadString);
        checkDistance();
    } catch {}
};

function checkDistance() {
    if (!userLoc || !busLoc) return;

    const d = distance(
        userLoc.lat,
        userLoc.lon,
        busLoc.lat,
        busLoc.lon
    );

    if (d < 0.2) {
        speak("Your bus is arriving now.");
    } else if (d < 0.5) {
        speak("Your bus is very close.");
    }
}

/* ==============================
   DISTANCE
================================ */
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;

    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>

</body>
</html>
