<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Bus App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: black; color: yellow; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
        #main-btn { 
            width: 100vw; height: 100vh; background: yellow; color: black; 
            font-size: 3rem; font-weight: bold; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body>

    <button id="main-btn">TAP TO START</button>

    <script>
        // --- 1. SETTINGS & BRAIN SETUP ---
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        let busDistance = 5.0; 
        const BUS_SPEED = 40; 
        const mainBtn = document.getElementById('main-btn');

        // Connect to the Driver Network
        const client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "user_" + Math.random());
        client.connect({onSuccess: () => { console.log("Network Ready"); }});

        // --- 2. THE START TRIGGER (WITH ECHO GUARD) ---
        mainBtn.onclick = () => {
            const welcome = new SpeechSynthesisUtterance("I am listening. Say your town number or name.");
            
            // THE ECHO GUARD: This makes sure the mic only starts AFTER the voice finishes
            welcome.onend = () => {
                mainBtn.innerText = "LISTENING NOW...";
                mainBtn.style.background = "#ff4444"; // Turn red when listening
                recognition.start();
            };

            synth.speak(welcome);
        };

        // --- 3. HANDLING THE VOICE INPUT ---
        recognition.onresult = (event) => {
            const voiceInput = event.results[0][0].transcript.toLowerCase().trim();
            mainBtn.style.background = "yellow";
            processDestination(voiceInput);
        };

        function processDestination(input) {
            // Dictionary to convert names to numbers
            const townMap = {
                "hospital": "101",
                "center": "101",
                "market": "205",
                "greenwich": "205"
            };

            let routeNumber = townMap[input] || input;

            speak("Searching for buses to " + input + ". Signaling route " + routeNumber);
            mainBtn.innerText = "SIGNALING DRIVER...";

            // Send signal to Driver Dashboard
            const message = new Paho.MQTT.Message("PASSENGER_WAITING_FOR_" + routeNumber);
            message.destinationName = "smart_bus_project/driver_alerts";
            client.send(message);

            // Start Countdown after 3 seconds
            setTimeout(() => { startSimulation(); }, 3000);
        }

        // --- 4. THE COUNTDOWN SIMULATION ---
        function startSimulation() {
            let eta = Math.round((busDistance / BUS_SPEED) * 60);
            speak("Bus found. It is " + eta + " minutes away.");
            
            const timer = setInterval(() => {
                busDistance -= 0.1; 
                eta = Math.round((busDistance / BUS_SPEED) * 60);
                
                mainBtn.innerText = eta + " MIN AWAY";

                if (busDistance <= 0.2) {
                    clearInterval(timer);
                    arrivalAlert();
                }
            }, 3000); 
        }

        function arrivalAlert() {
            mainBtn.innerText = "BUS ARRIVING!";
            mainBtn.style.background = "#00ff00"; // Green for arrival
            
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            speak("The bus is arriving now. Please prepare to board.");
        }
        function speak(text) {
            const utter = new SpeechSynthesisUtterance(text);
            synth.speak(utter);
        }

        recognition.onerror = () => {
            mainBtn.style.background = "yellow";
            mainBtn.innerText = "TAP TO TRY AGAIN";
            speak("Sorry, I didn't hear that.");
        };

    </script>
</body>
</html>