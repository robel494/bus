<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: yellow; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #main-btn { width: 90%; height: 80%; font-size: 3rem; font-weight: bold; background: black; color: yellow; border-radius: 20px; border: none; }
    </style>
</head>
<body>
    <button id="main-btn">TAP TO START</button>

    <script>
        const mainBtn = document.getElementById('main-btn');
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        const recognition = new SpeechRecognition();

        // SSL Port 8000 for GitHub Compatibility
        const client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "user_" + Math.random());

        client.connect({
            useSSL: true, 
            onSuccess: () => { console.log("Connected"); }
        });

        mainBtn.onclick = () => {
            // This 'unlocks' the speech on mobile browsers
            const msg = new SpeechSynthesisUtterance("Listening. Say your bus number.");
            synth.speak(msg);

            msg.onend = () => {
                mainBtn.style.background = "red";
                mainBtn.innerText = "LISTENING...";
                recognition.start();
            };
        };

        recognition.onresult = (event) => {
            const voiceInput = event.results[0][0].transcript;
            mainBtn.style.background = "black";
            mainBtn.innerText = "BUS " + voiceInput + " CALLED";
            
            // Send to Driver
            const message = new Paho.MQTT.Message("WAITING_" + voiceInput);
            message.destinationName = "smart_bus_project/driver_alerts";
            client.send(message);
            
            synth.speak(new SpeechSynthesisUtterance("Request sent for bus " + voiceInput));
        };
    </script>
</body>
</html>
