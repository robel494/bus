<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Smart Bus – Passenger</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
body {
    margin: 0;
    height: 100vh;
    background: #0f172a;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

h1 {
    font-size: 2.2rem;
}

input {
    margin-top: 15px;
    padding: 12px;
    font-size: 1.1rem;
    width: 220px;
    text-align: center;
    border-radius: 8px;
    border: none;
}

button {
    margin-top: 15px;
    padding: 12px 24px;
    font-size: 1.1rem;
    border: none;
    border-radius: 8px;
    background: #22c55e;
    color: black;
    cursor: pointer;
}

#status {
    margin-top: 20px;
    font-size: 1.1rem;
    color: #ccc;
}
</style>
</head>

<body>

<h1>Find My Bus</h1>

<input id="busInput" placeholder="Enter Bus Number" />

<button onclick="sendAlert()">Notify Driver</button>

<div id="status">Waiting…</div>

<script>
const statusEl = document.getElementById("status");
const busInput = document.getElementById("busInput");

let passengerLocation = null;
let busLocation = null;

/* ==============================
   MQTT
================================ */
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8884,
    "user_" + Math.random().toString(16).substr(2, 8)
);

client.connect({
    useSSL: true,
    onSuccess: () => {
        statusEl.innerText = "Connected";
        client.subscribe("smart_bus_project/bus_location");
        getUserLocation();
    }
});

/* ==============================
   SEND ALERT
================================ */
function sendAlert() {
    const bus = busInput.value.trim();
    if (!bus) return;

    const msg = new Paho.MQTT.Message(bus);
    msg.destinationName = "smart_bus_project/driver_alerts";
    client.send(msg);

    statusEl.innerText = "Alert sent to driver";
}

/* ==============================
   USER GPS
================================ */
function getUserLocation() {
    if (!navigator.geolocation) {
        statusEl.innerText = "GPS not supported";
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        passengerLocation = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
        };
    });
}

/* ==============================
   RECEIVE BUS GPS
================================ */
client.onMessageArrived = msg => {
    try {
        busLocation = JSON.parse(msg.payloadString);
        updateProximity();
    } catch {}
};

/* ==============================
   DISTANCE (RSSI SIMULATION)
================================ */
function updateProximity() {
    if (!passengerLocation || !busLocation) return;

    const d = distance(
        passengerLocation.lat,
        passengerLocation.lon,
        busLocation.lat,
        busLocation.lon
    );

    if (d < 0.3) {
        statusEl.innerText = "Bus is VERY CLOSE (" + d.toFixed(2) + " km)";
    } else if (d < 1) {
        statusEl.innerText = "Bus nearby (" + d.toFixed(2) + " km)";
    } else {
        statusEl.innerText = "Bus far (" + d.toFixed(2) + " km)";
    }
}

/* ==============================
   HAVERSINE FORMULA
================================ */
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;

    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>

</body>
</html>
